#!/bin/bash
# dev-clean: Clean LLM coding tool caches + dev build artifacts
# https://github.com/eyejoker/dev-clean

set -uo pipefail

VERSION="1.1.0"
PLIST_LABEL="com.eyejoker.dev-clean"
PLIST_FILE="$HOME/Library/LaunchAgents/${PLIST_LABEL}.plist"
WHITELIST_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/dev-clean/whitelist"

# --- Colors (disabled when not a terminal) ---
if [[ -t 1 ]]; then
  C_GREEN='\033[0;32m'
  C_YELLOW='\033[0;33m'
  C_BLUE='\033[0;34m'
  C_GRAY='\033[0;90m'
  C_BOLD='\033[1m'
  C_RESET='\033[0m'
else
  C_GREEN='' C_YELLOW='' C_BLUE='' C_GRAY='' C_BOLD='' C_RESET=''
fi

# --- Human-readable size ---
format_size() {
  local mb="$1"
  if [[ "$mb" -ge 1024 ]]; then
    printf "%.1f GB" "$(echo "$mb" | awk '{printf "%.1f", $1/1024}')"
  else
    printf "%s MB" "$mb"
  fi
}

show_help() {
  cat <<'HELP'
Usage: dev-clean [command]

Commands:
  (none)        Dry-run — preview what would be deleted (default)
  --run         Actually delete caches and artifacts
  --help        Show this help
  --version     Show version
  uninstall     Remove dev-clean, launchd schedule, and logs

Environment:
  DEV_CLEAN_DIRS  Colon-separated project directories to scan
                  (default: ~/Developer:~/Projects:~/Documents/GitHub:~/src:~/repos:~/code)

Whitelist:
  Add paths to exclude (one per line, # comments allowed):
    ~/.config/dev-clean/whitelist
HELP
  exit 0
}

do_uninstall() {
  echo ""
  echo -e "${C_BOLD}=== Uninstalling dev-clean ===${C_RESET}"
  echo ""

  local script="$HOME/.local/bin/dev-clean"
  if [[ -f "$script" ]]; then
    rm -f "$script"
    echo -e "  ${C_GREEN}✓${C_RESET} Removed $script"
  fi

  if [[ "$(uname -s)" == "Darwin" ]] && [[ -f "$PLIST_FILE" ]]; then
    launchctl bootout "gui/$(id -u)" "$PLIST_FILE" 2>/dev/null || true
    rm -f "$PLIST_FILE"
    echo -e "  ${C_GREEN}✓${C_RESET} Removed launchd schedule"
  fi

  local data_dir="$HOME/.local/share/dev-clean"
  if [[ -d "$data_dir" ]]; then
    rm -rf "$data_dir"
    echo -e "  ${C_GREEN}✓${C_RESET} Removed $data_dir"
  fi

  local config_dir
  config_dir="$(dirname "$WHITELIST_FILE")"
  if [[ -d "$config_dir" ]]; then
    rm -rf "$config_dir"
    echo -e "  ${C_GREEN}✓${C_RESET} Removed $config_dir"
  fi

  echo ""
  echo "Done."
  echo ""
  exit 0
}

case "${1:-}" in
  --help|-h)  show_help ;;
  --version)  echo "dev-clean $VERSION"; exit 0 ;;
  uninstall)  do_uninstall ;;
esac

DRY_RUN=true
[[ "${1:-}" == "--run" ]] && DRY_RUN=false

TOTAL_FREED=0
IS_MACOS=false
[[ "$(uname -s)" == "Darwin" ]] && IS_MACOS=true

# --- Whitelist ---
WHITELIST=()
if [[ -f "$WHITELIST_FILE" ]]; then
  while IFS= read -r line; do
    line="${line%%#*}"                   # strip comments
    line="${line#"${line%%[![:space:]]*}"}"  # trim leading
    line="${line%"${line##*[![:space:]]}"}"  # trim trailing
    [[ -z "$line" ]] && continue
    # expand ~ and $HOME
    line="${line/#\~/$HOME}"
    line="${line//\$HOME/$HOME}"
    WHITELIST+=("$line")
  done < "$WHITELIST_FILE"
fi

is_whitelisted() {
  local path="$1"
  for pattern in "${WHITELIST[@]+"${WHITELIST[@]}"}"; do
    # exact match or parent match
    if [[ "$path" == "$pattern" || "$path" == "$pattern"/* ]]; then
      return 0
    fi
  done
  return 1
}

# --- timeout wrapper (macOS has no coreutils timeout by default) ---
_timeout() {
  local secs="$1"; shift
  if command -v timeout &>/dev/null; then
    timeout "$secs" "$@"
  elif command -v gtimeout &>/dev/null; then
    gtimeout "$secs" "$@"
  else
    "$@"
  fi
}

# --- Dev project directories ---
DEFAULT_DIRS=(
  "$HOME/Developer"
  "$HOME/Projects"
  "$HOME/Documents/GitHub"
  "$HOME/src"
  "$HOME/repos"
  "$HOME/code"
)

if [[ -n "${DEV_CLEAN_DIRS:-}" ]]; then
  IFS=':' read -ra DEV_DIRS <<< "$DEV_CLEAN_DIRS"
else
  DEV_DIRS=("${DEFAULT_DIRS[@]}")
fi

# --- Helpers ---

freed() {
  local path="$1"
  local label="$2"
  [[ ! -e "$path" ]] && return

  if is_whitelisted "$path"; then
    printf "  ${C_GRAY}[SKP] %-45s whitelisted${C_RESET}\n" "$label"
    return
  fi

  local size
  size=$(du -sk "$path" 2>/dev/null | cut -f1)
  if [[ "$size" -gt 0 ]]; then
    local mb=$((size / 1024))
    TOTAL_FREED=$((TOTAL_FREED + mb))
    local human
    human=$(format_size "$mb")
    if $DRY_RUN; then
      printf "  ${C_YELLOW}[DRY]${C_RESET} %-45s %10s\n" "$label" "$human"
    else
      rm -rf "$path" 2>/dev/null
      printf "  ${C_GREEN}[DEL]${C_RESET} %-45s %10s\n" "$label" "$human"
    fi
  fi
}

delete_old_files() {
  local dir="$1"
  local days="$2"
  local label="$3"
  [[ ! -d "$dir" ]] && return

  if is_whitelisted "$dir"; then
    printf "  ${C_GRAY}[SKP] %-45s whitelisted${C_RESET}\n" "$label"
    return
  fi

  local size
  size=$(find "$dir" -mindepth 1 -maxdepth 1 -mtime +"$days" -exec du -sk {} + 2>/dev/null | awk '{s+=$1} END {print s+0}')
  if [[ "$size" -gt 0 ]]; then
    local mb=$((size / 1024))
    TOTAL_FREED=$((TOTAL_FREED + mb))
    local human
    human=$(format_size "$mb")
    if $DRY_RUN; then
      printf "  ${C_YELLOW}[DRY]${C_RESET} %-45s %10s (>%sd)\n" "$label" "$human" "$days"
    else
      find "$dir" -mindepth 1 -maxdepth 1 -mtime +"$days" -exec rm -rf {} +
      printf "  ${C_GREEN}[DEL]${C_RESET} %-45s %10s (>%sd)\n" "$label" "$human" "$days"
    fi
  fi
}

scan_build_artifacts() {
  local base_dir="$1"
  [[ ! -d "$base_dir" ]] && return

  # Rust target directories
  while IFS= read -r dir; do
    local label="${dir#"$base_dir"/}"
    freed "$dir" "rust target: $label"
  done < <(find "$base_dir" -maxdepth 5 -type d -name "target" \
    -not -path "*/node_modules/*" -not -path "*/.next/*" \
    \( -exec test -f "{}/CACHEDIR.TAG" \; -o -exec test -d "{}/debug/deps" \; -o -exec test -d "{}/release/deps" \; \) \
    -print 2>/dev/null)

  # Next.js build output
  while IFS= read -r dir; do
    local label="${dir#"$base_dir"/}"
    freed "$dir" ".next: $label"
  done < <(find "$base_dir" -name ".next" -type d -maxdepth 4 2>/dev/null)

  # Turbo cache
  while IFS= read -r dir; do
    local label="${dir#"$base_dir"/}"
    freed "$dir" ".turbo cache: $label"
  done < <(find "$base_dir" -name ".turbo" -type d -maxdepth 3 -exec test -d "{}/cache" \; -print 2>/dev/null)
}

# =============================================================================

echo ""
echo -e "${C_BOLD}=== dev-clean ===${C_RESET}"
if $DRY_RUN; then
  echo -e "${C_GRAY}(dry-run mode — nothing will be deleted)${C_RESET}"
fi
if [[ ${#WHITELIST[@]} -gt 0 ]]; then
  echo -e "${C_GRAY}(${#WHITELIST[@]} whitelisted path(s) loaded)${C_RESET}"
fi
echo ""

# --- Claude Code ---
echo -e "${C_BLUE}[Claude Code]${C_RESET}"
delete_old_files "$HOME/.claude/debug" 1 "debug logs (1d+)"
delete_old_files "$HOME/.claude/file-history" 14 "file-history (14d+)"
delete_old_files "$HOME/.claude/projects" 14 "projects (14d+)"

# --- Codex ---
echo -e "${C_BLUE}[Codex]${C_RESET}"
delete_old_files "$HOME/.codex/sessions" 14 "sessions (14d+)"
delete_old_files "$HOME/.codex/archived_sessions" 14 "archived_sessions (14d+)"
delete_old_files "$HOME/.codex/log" 7 "logs (7d+)"
freed "$HOME/.codex/worktrees" "worktrees"

# --- Package managers ---
echo -e "${C_BLUE}[Package Managers]${C_RESET}"
freed "$HOME/.npm/_cacache" "npm cache"
freed "$HOME/.npm/_npx" "npx cache"
freed "$HOME/.cache/uv" "uv (Python) cache"
freed "$HOME/.bun/install/cache" "bun install cache"
if ! $DRY_RUN; then
  command -v pnpm &>/dev/null && _timeout 120 pnpm store prune 2>/dev/null && printf "  ${C_GREEN}[RUN]${C_RESET} %-45s done\n" "pnpm store prune"
  command -v conda &>/dev/null && _timeout 120 conda clean --all -y 2>/dev/null | tail -1 && printf "  ${C_GREEN}[RUN]${C_RESET} %-45s done\n" "conda clean"
  command -v brew &>/dev/null && _timeout 120 brew cleanup 2>/dev/null && printf "  ${C_GREEN}[RUN]${C_RESET} %-45s done\n" "brew cleanup"
else
  command -v pnpm &>/dev/null && printf "  ${C_YELLOW}[DRY]${C_RESET} %-45s ${C_GRAY}(prune unused)${C_RESET}\n" "pnpm store prune"
  command -v conda &>/dev/null && printf "  ${C_YELLOW}[DRY]${C_RESET} %-45s ${C_GRAY}(tarballs+cache)${C_RESET}\n" "conda clean --all"
  command -v brew &>/dev/null && printf "  ${C_YELLOW}[DRY]${C_RESET} %-45s ${C_GRAY}(old versions)${C_RESET}\n" "brew cleanup"
fi

# --- Build artifacts (scan all dev directories) ---
echo -e "${C_BLUE}[Build Artifacts]${C_RESET}"
for dev_dir in "${DEV_DIRS[@]}"; do
  scan_build_artifacts "$dev_dir"
done

# --- Misc dev caches ---
echo -e "${C_BLUE}[Misc]${C_RESET}"
freed "$HOME/.cache/puppeteer" "puppeteer browsers"
freed "$HOME/.cursor/worktrees" "cursor worktrees"
freed "$HOME/.local/share/opencode" "opencode data"
freed "$HOME/.cache/opencode" "opencode cache"

# macOS-only
if $IS_MACOS; then
  freed "$HOME/Library/Caches/ms-playwright" "playwright browsers"
  freed "$HOME/Library/Developer/Xcode/DerivedData" "Xcode DerivedData"
  freed "$HOME/Library/Developer/Xcode/Archives" "Xcode Archives"
  freed "$HOME/Library/Developer/CoreSimulator/Caches" "iOS Simulator caches"
else
  freed "$HOME/.cache/ms-playwright" "playwright browsers"
fi

echo ""
total_human=$(format_size "$TOTAL_FREED")
echo -e "${C_BOLD}=== Total: ${total_human} ===${C_RESET}"
echo ""
